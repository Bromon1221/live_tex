<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>LaTeX Live PDF Preview</title>
  <script>
    window.MathJax = {
      tex: {inlineMath: [['$','$'], ['\\(','\\)']], displayMath: [['$$','$$'], ['\\[','\\]']]},
      svg: {fontCache: 'global'}
    };
  </script>
  <script defer src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
  <style>
    :root {
      --bg: #0b1020; --panel: #101833; --panel-2: #0f1a3b; --text: #e8ecf5;
      --muted:#a9b3c9; --border:#223055; --accent:#5aa9ff; --accent2:#16a34a;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0; background:var(--bg); color:var(--text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Noto Sans JP", "Hiragino Sans", "Yu Gothic", Meiryo, sans-serif}
    header{display:flex;gap:12px;align-items:center;padding:10px 16px;border-bottom:1px solid var(--border);background:linear-gradient(180deg,var(--panel),var(--panel-2))}
    .badge{font-size:12px;background:#223055;color:#ccddff;padding:4px 8px;border-radius:999px}
    h1{font-size:16px;margin:0}
    .app{display:grid;grid-template-columns:1fr 1fr;height:calc(100% - 56px)}
    .left,.right{padding:12px;overflow:auto}
    .card{height:100%;background:linear-gradient(180deg,var(--panel),var(--panel-2));border:1px solid var(--border);border-radius:12px;padding:12px;display:flex;flex-direction:column;gap:10px}
    textarea{flex:1;resize:vertical;width:100%;background:#0c1330;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:12px;font-size:14px;line-height:1.6;min-height:50vh}
    input[type="text"], select{width:100%;background:#0c1330;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px 12px}
    label{font-size:12px;color:var(--muted)}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:10px}
    .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .btn{background:linear-gradient(180deg,#3b82f6,#2563eb);border:0;color:white;border-radius:10px;padding:8px 12px;font-weight:600;cursor:pointer}
    .btn.secondary{background:linear-gradient(180deg,#16a34a,#15803d)}
    .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
    .status{font-size:12px;color:var(--muted);margin-left:auto}
    .previewWrap{flex:1;min-height:0;display:flex;flex-direction:column;gap:8px}
    .paper{background:white;color:black;border-radius:8px;border:1px solid #d0d5dd; padding:24px; width:100%; min-height:80vh}
    iframe{width:100%;height:100%;border:1px solid var(--border);border-radius:10px;background:white}
    @media (max-width: 980px){ .app{grid-template-columns:1fr; height:auto} iframe{min-height:50vh} }
    .hint{font-size:12px;color:var(--muted)}
    .insert-bar{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
    .insert-bar button{background:#1e293b;color:#e2e8f0;border:1px solid #334155;padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer}
    .insert-bar button:hover{background:#334155}
  </style>
</head>
<body>
  <header>
    <div class="badge">Live PDF</div>
    <h1>LaTeX ライブPDFプレビュー（クライアントのみ）</h1>
  </header>
  <main class="app">
    <section class="left">
      <div class="card">
        <div class="row">
          <div>
            <label>ドキュメントクラス</label>
            <select id="docClass">
              <option value="bxjsarticle">bxjsarticle</option>
              <option value="jsarticle">jsarticle</option>
              <option value="article">article</option>
            </select>
          </div>
          <div>
            <label>エンジン（表現）</label>
            <select id="engine">
              <option value="html">HTML+MathJax（軽量・高速）</option>
            </select>
          </div>
        </div>
        <div>
          <label>タイトル（任意）</label>
          <input id="title" type="text" placeholder="LaTeX Live Preview" />
        </div>
        <div>
          <label>章・画像テンプレ挿入</label>
          <div class="insert-bar">
            <button onclick="insertSnippet('section')">\section{章タイトル}</button>
            <button onclick="insertSnippet('subsection')">\subsection{小見出し}</button>
            <button onclick="insertSnippet('subsubsection')">\subsubsection{さらに小さい見出し}</button>
            <button onclick="insertSnippet('figure')">figure テンプレ</button>
            <button onclick="insertSnippet('itemize')">箇条書き</button>
          </div>
        </div>
        <div>
          <label>本文（TeX）</label>
          <textarea id="source" spellcheck="false"></textarea>
          <div class="hint">章・画像テンプレートボタンを押すと、カーソル位置にコードが挿入されます。</div>
        </div>
        <div class="toolbar">
          <button class="btn" id="compile">プレビュー更新</button>
          <button class="btn secondary" id="exportPdf">PDFを保存</button>
          <button class="btn ghost" id="reset">初期文に戻す</button>
          <span class="status" id="status">準備完了</span>
        </div>
      </div>
    </section>

    <section class="right">
      <div class="card previewWrap">
        <label>ライブプレビュー（PDF埋め込み）</label>
        <iframe id="pdfFrame" title="PDF preview"></iframe>
        <div class="hint">このPDFは右側の HTML レンダリング結果をその場でPDF化したものです（html2pdf.js）。</div>
      </div>
    </section>
  </main>

  <template id="docTemplate">
    <article class="paper" id="paper">
      <h1 id="docTitle"></h1>
      <div id="docBody"></div>
    </article>
  </template>

  <script>
    const $ = (id)=>document.getElementById(id);
    const statusEl = $("status");

    function insertAtCursor(textarea, text) {
      const start = textarea.selectionStart;
      const end = textarea.selectionEnd;
      const before = textarea.value.substring(0, start);
      const after  = textarea.value.substring(end, textarea.value.length);
      textarea.value = before + text + after;
      textarea.selectionStart = textarea.selectionEnd = start + text.length;
      textarea.focus();
    }

    function insertSnippet(type) {
      const textarea = $("source");
      let code = '';
      switch(type){
        case 'section': code = "\\section{ここに章タイトル}"; break;
        case 'subsection': code = "\\subsection{ここに小見出し}"; break;
        case 'subsubsection': code = "\\subsubsection{さらに小さい見出し}"; break;
        case 'figure': code = "\\begin{figure}[htbp]\n  \\centering\n  \\includegraphics[width=0.8\\linewidth]{example-image}\n  \\caption{キャプション}\n  \\label{fig:sample}\n\\end{figure}"; break;
        case 'itemize': code = "\\begin{itemize}\n  \\item 項目1\n  \\item 項目2\n\\end{itemize}"; break;
      }
      insertAtCursor(textarea, "\n" + code + "\n");
    }

    function latexToSimpleHtml(tex){
      let html = tex
        .replace(/\\section\{([^}]*)\}/g, '<h2>$1</h2>')
        .replace(/\\subsection\{([^}]*)\}/g, '<h3>$1</h3>')
        .replace(/\\subsubsection\{([^}]*)\}/g, '<h4>$1</h4>')
        .replace(/\\paragraph\{([^}]*)\}/g, '<h5>$1</h5>')
        .replace(/\\begin\{itemize\}[\s\S]*?\\end\{itemize\}/g, m=>{
          const items = m.replace(/\\begin\{itemize\}|\\end\{itemize\}/g,'').split(/\\item\s*/).filter(Boolean).map(s=>`<li>${s.trim()}</li>`).join('');
          return `<ul>${items}</ul>`;
        })
        .replace(/\\par/g, '<p></p>')
        .replace(/\\\\/g, '<br/>')
        .replace(/\\includegraphics\[[^\]]*\]\{([^}]*)\}/g, '<div style="text-align:center"><img src="$1" alt="image" style="max-width:90%"></div>');
      return html;
    }

    async function renderPreview(){
      const title = $("title").value || "LaTeX Live Preview";
      const src = $("source").value;

      const bodyHtml = latexToSimpleHtml(src);
      const tmpl = $("docTemplate").content.cloneNode(true);
      tmpl.getElementById("docTitle").textContent = title;
      tmpl.getElementById("docBody").innerHTML = bodyHtml;

      const container = document.createElement('div');
      container.appendChild(tmpl);
      document.body.appendChild(container);
      await MathJax.typesetPromise([container]);

      const node = container.querySelector('#paper');
      const opt = {
        margin:[10,10,10,10], filename:'preview.pdf', image:{ type:'jpeg', quality:0.98 }, html2canvas:{ scale:2, useCORS:true }, jsPDF:{ unit:'mm', format:'a4', orientation:'portrait' }
      };
      const worker = html2pdf().set(opt).from(node);
      const pdfBlob = await worker.outputPdf('blob');

      const url = URL.createObjectURL(pdfBlob);
      $("pdfFrame").src = url;
      setTimeout(()=>{ document.body.removeChild(container); }, 0);
      statusEl.textContent = new Date().toLocaleTimeString() + ' に更新';
    }

    function debounce(fn, ms){ let t; return (...args)=>{ clearTimeout(t); t = setTimeout(()=>fn(...args), ms); }; }
    const debouncedRender = debounce(renderPreview, 400);

    $("compile").addEventListener('click', renderPreview);
    $("source").addEventListener('input', debouncedRender);
    $("title").addEventListener('input', debouncedRender);

    $("exportPdf").addEventListener('click', async ()=>{
      const frame = $("pdfFrame");
      if (!frame.src) { await renderPreview(); }
      const a = document.createElement('a');
      a.href = frame.src; a.download = 'document.pdf'; a.click();
    });

    $("reset").addEventListener('click', ()=>{
      $("title").value = 'LaTeX Live Preview';
      $("source").value = `% ここに本文を書いてください。数式は $a^2+b^2=c^2$ や \\[ E=mc^2 \\] のように。\n\\section{はじめに}\nこのページは、左でTeXを編集し、右でライブPDF風プレビューを表示します。\\par\n日本語は LuaLaTeX を意識したフォント設定にしていませんが、MathJaxで数式は正しく描画されます。\n\n\\subsection{数式}\nオイラーの公式： $e^{i\\pi}+1=0$.\n\n\\subsection{箇条書き}\n\\begin{itemize}\n  \\item 項目1\n  \\item 項目2\n\\end{itemize}`;
      renderPreview();
    });

    renderPreview();
  </script>
</body>
</html>
